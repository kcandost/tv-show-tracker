<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV Show Tracker</title>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for in-browser JSX (MVP-friendly, not the leanest for perf) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase v2 UMD (must be the UMD build for window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    /* ===== Gruvbox (minimal) ===== */
    :root{
      --bg:#282828;--bg2:#32302f;--bg3:#1d2021;
      --fg:#ebdbb2;--fg2:#a89984;--bd:#928374;
      --y:#fabd2f;--b:#83a598;--a:#8ec07c;--g:#b8bb26;--r:#fb4934;
    }
    [data-theme="light"]{
      --bg:#fbf1c7;--bg2:#f2e5bc;--bg3:#f9f5d7;
      --fg:#3c3836;--fg2:#665c54;--bd:#7c6f64;
      --y:#d79921;--b:#458588;--a:#689d6a;--g:#98971a;--r:#cc241d;
    }
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--fg);line-height:1.5}
    a{color:var(--b);text-decoration:none} a:hover{color:var(--a);text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--bd);padding-bottom:14px;margin-bottom:16px}
    h1{margin:0;color:var(--y);font-size:1.6rem}
    .btn{border:0;border-radius:6px;padding:10px 14px;font-weight:650;cursor:pointer;background:var(--b);color:var(--bg);transition:.15s}
    .btn:hover{background:var(--a);transform:translateY(-1px)}
    .btn:disabled{background:var(--bd);cursor:not-allowed;transform:none}
    .btn.ghost{background:var(--bg2);color:var(--fg);border:1px solid var(--bd)}
    .btn.ghost:hover{border-color:var(--y);background:var(--bg3)}
    .btn.danger{background:var(--r)} .btn.danger:hover{filter:brightness(.95)}
    input,select{background:var(--bg);color:var(--fg);border:1px solid var(--bd);border-radius:6px;padding:10px;font-size:14px}
    input:focus,select:focus{outline:none;border-color:var(--b)}
    .card{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .mt{margin-top:12px}
    .tabs{display:flex;gap:10px;margin:14px 0}
    .tab{background:var(--bg2);border:1px solid var(--bd);color:var(--fg)}
    .tab.active{background:var(--b);color:var(--bg);border-color:var(--b)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
    .sr{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;max-height:360px;overflow:auto}
    .sr-item{background:var(--bg3);border:1px solid var(--bd);border-radius:8px;padding:10px;cursor:pointer;transition:.15s}
    .sr-item:hover{border-color:var(--y);transform:translateY(-2px)}
    .sr-item img{width:100%;height:240px;object-fit:cover;border-radius:6px;margin-bottom:8px}
    .meta{color:var(--fg2);font-size:.88rem}
    .show-h{display:flex;gap:12px}
    .poster{width:95px;height:135px;object-fit:cover;border-radius:8px}
    .title{color:var(--y);margin:0 0 4px 0;font-size:1.05rem}
    .bar{background:var(--bg3);border-radius:999px;height:18px;overflow:hidden;margin:8px 0}
    .fill{height:100%;background:linear-gradient(90deg,var(--g),var(--a));display:flex;align-items:center;justify-content:center;color:var(--bg);font-size:.75rem;font-weight:700}
    .pill{background:var(--bg3);border-radius:8px;padding:8px;margin-top:8px}
    .controls input{width:64px;padding:8px}
    .empty{padding:48px 10px;text-align:center;color:var(--fg2)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:18px}
    .modal > .card{max-width:520px;width:100%;border:2px solid var(--bd)}
    label{display:block;margin:10px 0 6px;color:var(--fg2);font-size:.9rem}
    pre.err{margin:0;padding:16px;white-space:pre-wrap;font:14px/1.35 ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- Show errors instead of a blank page -->
  <script>
    window.addEventListener("error", (e) => {
      document.body.innerHTML = `<pre class="err">JS Error: ${e.message}\n${e.filename || ""}:${e.lineno || ""}:${e.colno || ""}</pre>`;
    });
    window.addEventListener("unhandledrejection", (e) => {
      document.body.innerHTML = `<pre class="err">Promise Rejection: ${String(e.reason)}</pre>`;
    });
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ‚úÖ Your Supabase creds (kept as-is)
    const SUPABASE_URL = "https://oszjxfffcbxrlwheywzh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zemp4ZmZmY2J4cmx3aGV5d3poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTE3MDYsImV4cCI6MjA4MTQ4NzcwNn0.EF1Wu5ljbnn9uydd89wP0VbZm0da8cvP5CJjjoj9NG0";

    if (!window.supabase) throw new Error("Supabase UMD not loaded (window.supabase missing).");
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TABS = [
      { key: "not-started", label: "Not Started" },
      { key: "in-progress", label: "In Progress" },
      { key: "completed", label: "Completed" },
    ];

    const pct = (cur, total) => (!total ? 0 : Math.max(0, Math.min(100, Math.round((cur / total) * 100))));

    async function fetchEpisodes(showId) {
      const r = await fetch(`https://api.tvmaze.com/shows/${showId}/episodes`);
      if (!r.ok) throw new Error("TVMaze episodes request failed");
      return r.json();
    }

    function App() {
      const [theme, setTheme] = useState("dark");
      const [activeTab, setActiveTab] = useState("in-progress");
      const [shows, setShows] = useState([]);
      const [loading, setLoading] = useState(true);

      const [q, setQ] = useState("");
      const [searching, setSearching] = useState(false);
      const [results, setResults] = useState([]);

      const [filter, setFilter] = useState("");
      const [sortBy, setSortBy] = useState("name");

      const [draft, setDraft] = useState(null);

      useEffect(() => document.documentElement.setAttribute("data-theme", theme), [theme]);

      useEffect(() => { (async () => {
        try {
          const { data, error } = await db.from("shows").select("*");
          if (error) throw error;
          setShows(data || []);
        } finally {
          setLoading(false);
        }
      })(); }, []);

      const counts = useMemo(() => ({
        "not-started": shows.filter(s => s.status === "not-started").length,
        "in-progress": shows.filter(s => s.status === "in-progress").length,
        "completed":   shows.filter(s => s.status === "completed").length,
      }), [shows]);

      const visible = useMemo(() => {
        let out = shows.filter(s => s.status === activeTab);
        if (filter.trim()) {
          const f = filter.toLowerCase();
          out = out.filter(s => (s.name || "").toLowerCase().includes(f));
        }
        out.sort((a,b) => {
          if (sortBy === "name") return (a.name || "").localeCompare(b.name || "");
          if (sortBy === "progress") return pct(b.current_episode, b.total_episodes) - pct(a.current_episode, a.total_episodes);
          if (sortBy === "recent") return new Date(b.updated_at) - new Date(a.updated_at);
          return 0;
        });
        return out;
      }, [shows, activeTab, filter, sortBy]);

      async function doSearch() {
        if (!q.trim()) return;
        setSearching(true);
        try {
          const r = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(q)}`);
          if (!r.ok) throw new Error("TVMaze search failed");
          setResults(await r.json());
        } finally {
          setSearching(false);
        }
      }

      async function pickShow(item) {
        const show = item.show;
        let total = 0;
        try { total = (await fetchEpisodes(show.id)).length; } catch {}
        setDraft({
          tvmaze_id: show.id,
          name: show.name,
          image_url: show.image?.medium || show.image?.original || null,
          current_season: 1,
          current_episode: 0,
          total_episodes: total,
          status: "not-started",
          source: "",
          premiered: show.premiered || "",
          genres: (show.genres || []).join(", "),
        });
        setResults([]);
        setQ("");
      }

      async function saveDraft() {
        const { data, error } = await db.from("shows").insert([draft]).select();
        if (error) throw error;
        setShows(prev => [...prev, data[0]]);
        setDraft(null);
      }

      async function updateShow(id, updates) {
        const { error } = await db.from("shows").update(updates).eq("id", id);
        if (error) throw error;
        setShows(prev => prev.map(s => (s.id === id ? { ...s, ...updates } : s)));
      }

      async function removeShow(id) {
        if (!confirm("Delete this show?")) return;
        const { error } = await db.from("shows").delete().eq("id", id);
        if (error) throw error;
        setShows(prev => prev.filter(s => s.id !== id));
      }

      if (loading) {
        return <div className="wrap"><div className="empty">Loading your shows‚Ä¶</div></div>;
      }

      return (
        <div className="wrap">
          <header>
            <h1>üì∫ TV Show Tracker</h1>
            <button className="btn ghost" onClick={() => setTheme(t => t === "dark" ? "light" : "dark")}>
              {theme === "dark" ? "‚òÄÔ∏è Light" : "üåô Dark"}
            </button>
          </header>

          <div className="card">
            <div className="row">
              <input
                className="grow"
                placeholder="Search TVMaze‚Ä¶"
                value={q}
                onChange={(e) => setQ(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && doSearch()}
              />
              <button className="btn" onClick={doSearch} disabled={searching}>
                {searching ? "Searching‚Ä¶" : "Search"}
              </button>
            </div>

            {results.length > 0 && (
              <div className="sr mt">
                {results.map(r => (
                  <div key={r.show.id} className="sr-item" onClick={() => pickShow(r)}>
                    <img
                      src={r.show.image?.medium || r.show.image?.original || "https://via.placeholder.com/200x280?text=No+Image"}
                      alt={r.show.name}
                    />
                    <div style={{fontWeight:700}}>{r.show.name}</div>
                    <div className="meta">{r.show.premiered?.slice(0,4) || ""}</div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="tabs">
            {TABS.map(t => (
              <button
                key={t.key}
                className={`btn tab ${activeTab === t.key ? "active" : ""}`}
                onClick={() => setActiveTab(t.key)}
              >
                {t.label} ({counts[t.key]})
              </button>
            ))}
          </div>

          <div className="row mt">
            <input className="grow" placeholder="Filter shows‚Ä¶" value={filter} onChange={(e)=>setFilter(e.target.value)} />
            <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)}>
              <option value="name">Sort: Name</option>
              <option value="progress">Sort: Progress</option>
              <option value="recent">Sort: Recent</option>
            </select>
          </div>

          {visible.length === 0 ? (
            <div className="empty">
              <div style={{color:"var(--y)",fontWeight:800,fontSize:"1.1rem"}}>No shows here yet</div>
              <div className="meta">Search above and add a show to get started.</div>
            </div>
          ) : (
            <div className="grid mt">
              {visible.map(s => (
                <ShowCard
                  key={s.id}
                  show={s}
                  onUpdate={updateShow}
                  onDelete={removeShow}
                />
              ))}
            </div>
          )}

          {draft && (
            <AddModal
              show={draft}
              onClose={()=>setDraft(null)}
              onChange={setDraft}
              onSave={saveDraft}
            />
          )}
        </div>
      );
    }

    function ShowCard({ show, onUpdate, onDelete }) {
      const [next, setNext] = useState(null);
      const [season, setSeason] = useState(show.current_season);
      const [ep, setEp] = useState(show.current_episode);

      useEffect(() => {
        let cancelled = false;
        (async () => {
          try {
            const eps = await fetchEpisodes(show.tvmaze_id);
            const n = eps.find(x => x.season > show.current_season || (x.season === show.current_season && x.number > show.current_episode)) || null;
            if (!cancelled) setNext(n);
          } catch {
            if (!cancelled) setNext(null);
          }
        })();
        return () => { cancelled = true; };
      }, [show.tvmaze_id, show.current_season, show.current_episode]);

      const progress = pct(show.current_episode, show.total_episodes);
      const left = Math.max(0, (show.total_episodes || 0) - (show.current_episode || 0));

      async function applyProgress() {
        // MVP approximation: map (season,episode) -> episode count using 20 eps/season.
        const approxWatched = (ep || 0) + (Math.max(1, season) - 1) * 20;
        let status = show.status;
        if (approxWatched >= (show.total_episodes || 0)) status = "completed";
        else if (approxWatched > 0) status = "in-progress";
        await onUpdate(show.id, { current_season: Math.max(1, season), current_episode: Math.max(0, ep), status });
      }

      return (
        <div className="card">
          <div className="show-h">
            <img className="poster" src={show.image_url || "https://via.placeholder.com/100x140?text=No+Image"} alt={show.name} />
            <div className="grow">
              <h3 className="title">{show.name}</h3>
              <div className="meta">
                {show.genres ? <div>üé≠ {show.genres}</div> : null}
                {show.premiered ? <div>üìÖ {show.premiered}</div> : null}
              </div>
              {show.source ? (
                <a className="meta" href={show.source} target="_blank" rel="noopener noreferrer">üîó Watch Source</a>
              ) : null}
            </div>
          </div>

          <div className="meta mt">S{show.current_season} E{show.current_episode} ‚Ä¢ {show.total_episodes || 0} eps</div>

          <div className="bar">
            <div className="fill" style={{ width: `${progress}%` }}>{progress >= 12 ? `${progress}%` : ""}</div>
          </div>

          <div className="meta">{left ? `${left} episodes left` : "All caught up!"}</div>

          {next && (
            <div className="pill meta">
              <b style={{color:"var(--y)"}}>Next:</b> S{next.season} E{next.number} ‚Äî {next.name}{next.airdate ? ` (${next.airdate})` : ""}
            </div>
          )}

          <div className="row controls mt">
            <span className="meta">S</span>
            <input type="number" min="1" value={season} onChange={(e)=>setSeason(parseInt(e.target.value)||1)} />
            <span className="meta">E</span>
            <input type="number" min="0" value={ep} onChange={(e)=>setEp(parseInt(e.target.value)||0)} />
            <button className="btn" style={{padding:"8px 12px"}} onClick={applyProgress}>Update</button>
            <button className="btn danger" style={{padding:"8px 12px"}} onClick={()=>onDelete(show.id)}>Delete</button>
          </div>
        </div>
      );
    }

    function AddModal({ show, onClose, onChange, onSave }) {
      return (
        <div className="modal" onClick={onClose}>
          <div className="card" onClick={(e)=>e.stopPropagation()}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"start",gap:10}}>
              <div>
                <div style={{color:"var(--y)",fontWeight:900,fontSize:"1.15rem"}}>Add: {show.name}</div>
                <div className="meta">Total Episodes: {show.total_episodes || 0}</div>
              </div>
              <button className="btn ghost" onClick={onClose} style={{padding:"8px 12px"}}>‚úï</button>
            </div>

            <label>Starting Season</label>
            <input type="number" min="1" value={show.current_season}
              onChange={(e)=>onChange({ ...show, current_season: parseInt(e.target.value) || 1 })} />

            <label>Starting Episode</label>
            <input type="number" min="0" value={show.current_episode}
              onChange={(e)=>onChange({ ...show, current_episode: parseInt(e.target.value) || 0 })} />

            <label>Watch Source (URL or platform)</label>
            <input type="text" placeholder="Netflix or https://‚Ä¶" value={show.source || ""}
              onChange={(e)=>onChange({ ...show, source: e.target.value })} />

            <label>Status</label>
            <select value={show.status} onChange={(e)=>onChange({ ...show, status: e.target.value })}>
              <option value="not-started">Not Started</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>

            <div className="row mt" style={{justifyContent:"flex-end"}}>
              <button className="btn ghost" onClick={onClose}>Cancel</button>
              <button className="btn" onClick={onSave}>Add Show</button>
            </div>
          </div>
        </div>
      );
    }

    // ‚úÖ FIXED: React 18 uses ReactDOM.createRoot (NOT ReactDOMClient)
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
