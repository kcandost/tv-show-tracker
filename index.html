<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV Show Tracker</title>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX in a single HTML file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;line-height:1.5}
    :root{
      --bg:#282828;--bg2:#32302f;--bg3:#1d2021;--fg:#ebdbb2;--fg2:#a89984;--bd:#928374;
      --red:#fb4934;--green:#b8bb26;--yellow:#fabd2f;--blue:#83a598;--aqua:#8ec07c;
    }
    [data-theme="light"]{
      --bg:#fbf1c7;--bg2:#f2e5bc;--bg3:#f9f5d7;--fg:#3c3836;--fg2:#665c54;--bd:#7c6f64;
      --red:#cc241d;--green:#98971a;--yellow:#d79921;--blue:#458588;--aqua:#689d6a;
    }
    body{background:var(--bg);color:var(--fg);transition:background-color .2s,color .2s}
    a{color:var(--blue);text-decoration:none} a:hover{color:var(--aqua);text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:2px solid var(--bd);padding-bottom:14px;margin-bottom:16px}
    h1{margin:0;color:var(--yellow);font-size:1.6rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1;min-width:220px}
    .card{background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px}
    .muted{color:var(--fg2)}
    input,select,textarea{background:var(--bg);color:var(--fg);border:1px solid var(--bd);border-radius:8px;padding:10px;font-size:14px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--blue)}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--blue);color:var(--bg);transition:.15s}
    .btn:hover{background:var(--aqua);transform:translateY(-1px)}
    .btn:disabled{background:var(--bd);cursor:not-allowed;transform:none}
    .btn.ghost{background:var(--bg2);color:var(--fg);border:1px solid var(--bd)}
    .btn.ghost:hover{background:var(--bg3);border-color:var(--yellow)}
    .btn.danger{background:var(--red)} .btn.danger:hover{filter:brightness(.95)}
    .tabs{display:flex;gap:10px;margin:14px 0;flex-wrap:wrap}
    .tab{background:var(--bg2);border:1px solid var(--bd);color:var(--fg)}
    .tab.active{background:var(--blue);color:var(--bg);border-color:var(--blue)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-top:14px}
    .sr{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;max-height:360px;overflow:auto;margin-top:12px}
    .srItem{background:var(--bg3);border:1px solid var(--bd);border-radius:10px;padding:10px;cursor:pointer;transition:.15s}
    .srItem:hover{border-color:var(--yellow);transform:translateY(-2px)}
    .srItem img{width:100%;height:240px;object-fit:cover;border-radius:8px;margin-bottom:8px}
    .showH{display:flex;gap:12px}
    .poster{width:95px;height:135px;object-fit:cover;border-radius:10px}
    .title{margin:0 0 4px 0;color:var(--yellow);font-size:1.05rem}
    .bar{background:var(--bg3);border-radius:999px;height:18px;overflow:hidden;margin:8px 0}
    .fill{height:100%;background:linear-gradient(90deg,var(--green),var(--aqua));display:flex;align-items:center;justify-content:center;color:var(--bg);font-size:.75rem;font-weight:800}
    .pill{background:var(--bg3);border-radius:10px;padding:8px;margin-top:8px}
    .controls input{width:72px;padding:8px}
    .empty{padding:48px 10px;text-align:center;color:var(--fg2)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:18px}
    .modal .card{max-width:560px;width:100%;border:2px solid var(--bd)}
    label{display:block;margin:10px 0 6px;color:var(--fg2);font-size:.9rem}
    pre.err{margin:0;padding:16px;white-space:pre-wrap;font:14px/1.35 ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- show errors instead of a blank page -->
  <script>
    window.addEventListener("error", (e) => {
      document.body.innerHTML = `<pre class="err">JS Error: ${e.message}\n${e.filename || ""}:${e.lineno || ""}:${e.colno || ""}</pre>`;
    });
    window.addEventListener("unhandledrejection", (e) => {
      document.body.innerHTML = `<pre class="err">Promise Rejection: ${String(e.reason)}</pre>`;
    });
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const LS_URL = "tvtracker_supabase_url";
    const LS_KEY = "tvtracker_supabase_anon_key";

    const TABS = [
      { key: "not-started", label: "Not Started" },
      { key: "in-progress", label: "In Progress" },
      { key: "completed", label: "Completed" },
    ];

    const pct = (cur, total) => (!total ? 0 : Math.max(0, Math.min(100, Math.round((cur / total) * 100))));
    const redirectTo = window.location.origin + window.location.pathname;

    function makeClient(url, key) {
      if (!window.supabase) throw new Error("Supabase UMD not loaded (window.supabase missing).");
      return window.supabase.createClient(url, key);
    }

    async function handleOAuthRedirect(supabase) {
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return;

      const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
      if (error) throw error;

      url.searchParams.delete("code");
      url.searchParams.delete("state");
      window.history.replaceState({}, document.title, url.toString());
    }

    async function tvmazeSearch(q) {
      const r = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(q)}`);
      if (!r.ok) throw new Error("TVMaze search failed");
      return r.json();
    }

    async function tvmazeEpisodes(showId) {
      const r = await fetch(`https://api.tvmaze.com/shows/${showId}/episodes`);
      if (!r.ok) throw new Error("TVMaze episodes failed");
      return r.json();
    }

    function App() {
      const [theme, setTheme] = useState("dark");

      // Saved credentials (actual)
      const [sbUrl, setSbUrl] = useState(localStorage.getItem(LS_URL) || "");
      const [sbKey, setSbKey] = useState(localStorage.getItem(LS_KEY) || "");

      // Draft credentials (form inputs) - decoupled from saved
      const [draftUrl, setDraftUrl] = useState(sbUrl);
      const [draftKey, setDraftKey] = useState(sbKey);

      const hasCreds = !!(sbUrl && sbKey);

      // Setup UX
      const [showKey, setShowKey] = useState(false);
      const [testing, setTesting] = useState(false);
      const [testMsg, setTestMsg] = useState("");

      // Supabase + auth
      const [supabase, setSupabase] = useState(null);
      const [session, setSession] = useState(null);
      const [authLoading, setAuthLoading] = useState(false);

      // Data/UI
      const [loading, setLoading] = useState(false);
      const [shows, setShows] = useState([]);
      const [activeTab, setActiveTab] = useState("in-progress");

      const [q, setQ] = useState("");
      const [searching, setSearching] = useState(false);
      const [results, setResults] = useState([]);

      const [filter, setFilter] = useState("");
      const [sortBy, setSortBy] = useState("name");

      const [draft, setDraft] = useState(null);

      useEffect(() => document.documentElement.setAttribute("data-theme", theme), [theme]);

      // Initialize Supabase client only from SAVED creds (not from what user is typing)
      useEffect(() => {
        if (!hasCreds) { setSupabase(null); setSession(null); return; }
        const client = makeClient(sbUrl.trim(), sbKey.trim());
        setSupabase(client);

        // Critical: exchange OAuth code for a stored session
        handleOAuthRedirect(client).catch(console.error);
      }, [hasCreds, sbUrl, sbKey]);

      // Auth subscription
      useEffect(() => {
        if (!supabase) return;
        let sub;

        (async () => {
          setAuthLoading(true);
          const { data } = await supabase.auth.getSession();
          setSession(data.session ?? null);

          const { data: s } = supabase.auth.onAuthStateChange((_event, newSession) => {
            setSession(newSession ?? null);
          });
          sub = s?.subscription;
          setAuthLoading(false);
        })();

        return () => sub?.unsubscribe?.();
      }, [supabase]);

      // Load shows after login
      useEffect(() => {
        if (!supabase || !session) return;
        (async () => {
          setLoading(true);
          try {
            const { data, error } = await supabase.from("shows").select("*");
            if (error) throw error;
            setShows(data || []);
          } finally {
            setLoading(false);
          }
        })();
      }, [supabase, session]);

      const counts = useMemo(() => ({
        "not-started": shows.filter(s => s.status === "not-started").length,
        "in-progress": shows.filter(s => s.status === "in-progress").length,
        "completed": shows.filter(s => s.status === "completed").length,
      }), [shows]);

      const visible = useMemo(() => {
        let out = shows.filter(s => s.status === activeTab);
        if (filter.trim()) {
          const f = filter.toLowerCase();
          out = out.filter(s => (s.name || "").toLowerCase().includes(f));
        }
        out.sort((a,b) => {
          if (sortBy === "name") return (a.name || "").localeCompare(b.name || "");
          if (sortBy === "progress") return pct(b.current_episode, b.total_episodes) - pct(a.current_episode, a.total_episodes);
          if (sortBy === "recent") return new Date(b.updated_at) - new Date(a.updated_at);
          return 0;
        });
        return out;
      }, [shows, activeTab, filter, sortBy]);

      function clearDraft() {
        setDraftUrl("");
        setDraftKey("");
        setTestMsg("");
      }

      async function saveSetup() {
        const u = draftUrl.trim(), k = draftKey.trim();
        if (!u || !k) return;
        localStorage.setItem(LS_URL, u);
        localStorage.setItem(LS_KEY, k);
        setSbUrl(u);
        setSbKey(k);
        setTestMsg("");
      }

      function resetSetup() {
        localStorage.removeItem(LS_URL);
        localStorage.removeItem(LS_KEY);
        setSbUrl(""); setSbKey("");
        setDraftUrl(""); setDraftKey("");
        setSupabase(null);
        setSession(null);
        setShows([]);
        setResults([]);
        setDraft(null);
        setTestMsg("");
        setShowKey(false);
      }

      async function testConnection() {
        setTesting(true);
        setTestMsg("");
        try {
          const u = draftUrl.trim();
          const k = draftKey.trim();
          if (!u || !k) throw new Error("Please paste both the Project URL and anon key.");
          const client = makeClient(u, k);

          const { error } = await client.from("shows").select("id").limit(1);
          if (error) throw error;

          setTestMsg("Connection looks good.");
        } catch (e) {
          setTestMsg(`Could not connect: ${e.message || String(e)}`);
        } finally {
          setTesting(false);
        }
      }

      async function signInWithGitHub() {
        const { error } = await supabase.auth.signInWithOAuth({
          provider: "github",
          options: { redirectTo }
        });
        if (error) throw error;
      }

      async function signOut() {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        setShows([]);
      }

      async function doSearch() {
        if (!q.trim()) return;
        setSearching(true);
        try {
          setResults(await tvmazeSearch(q.trim()));
        } finally {
          setSearching(false);
        }
      }

      async function pickShow(item) {
        const show = item.show;
        let total = 0;
        try { total = (await tvmazeEpisodes(show.id)).length; } catch {}
        setDraft({
          tvmaze_id: show.id,
          name: show.name,
          image_url: show.image?.medium || show.image?.original || null,
          current_season: 1,
          current_episode: 0,
          total_episodes: total,
          status: "not-started",
          source: "",
          premiered: show.premiered || "",
          genres: (show.genres || []).join(", "),
        });
        setResults([]);
        setQ("");
      }

      async function saveDraft() {
        const { data, error } = await supabase.from("shows").insert([draft]).select();
        if (error) throw error;
        setShows(prev => [...prev, data[0]]);
        setDraft(null);
      }

      async function updateShow(id, updates) {
        const { error } = await supabase.from("shows").update(updates).eq("id", id);
        if (error) throw error;
        setShows(prev => prev.map(s => (s.id === id ? { ...s, ...updates } : s)));
      }

      async function removeShow(id) {
        if (!confirm("Delete this show?")) return;
        const { error } = await supabase.from("shows").delete().eq("id", id);
        if (error) throw error;
        setShows(prev => prev.filter(s => s.id !== id));
      }

      // ---- Screens
      if (!hasCreds) {
        return (
          <div className="wrap">
            <Header theme={theme} setTheme={setTheme} right={<button className="btn ghost" onClick={resetSetup}>Start over</button>} />

            <div className="card">
              <div style={{ fontWeight: 900, marginBottom: 6 }}>Connect your Supabase (one-time)</div>
              <div className="muted" style={{ marginBottom: 12 }}>
                This app is static (GitHub Pages). Your shows are stored in <b>your</b> Supabase project and protected by
                GitHub login + Row Level Security.
              </div>

              <div className="pill muted" style={{ marginBottom: 12, fontSize: 13 }}>
                <div style={{ marginBottom: 6, fontWeight: 800, color: "var(--yellow)" }}>Quick steps</div>
                <div>1) Supabase Project Settings → API → copy Project URL + anon key</div>
                <div>2) Paste them below and click Save</div>
                <div>3) Sign in with GitHub to access your private list</div>
              </div>

              <label>Supabase Project URL</label>
              <input
                className="grow"
                value={draftUrl}
                onChange={(e) => setDraftUrl(e.target.value)}
                placeholder="Example: https://abcdxyz.supabase.co"
                spellCheck="false"
              />
              <div className="muted" style={{ fontSize: 13, marginTop: 6 }}>
                Find it in Supabase: Project Settings → API → Project URL
              </div>

              <label style={{ marginTop: 12 }}>Supabase anon public key</label>
              <div className="row" style={{ alignItems: "stretch" }}>
                <textarea
                  className="grow"
                  rows="3"
                  value={draftKey}
                  onChange={(e) => setDraftKey(e.target.value)}
                  placeholder="Starts with: eyJhbGciOi..."
                  spellCheck="false"
                  style={showKey ? {} : { WebkitTextSecurity: "disc" }}
                />
                <button className="btn ghost" onClick={() => setShowKey(v => !v)} style={{ whiteSpace: "nowrap" }}>
                  {showKey ? "Hide key" : "Show key"}
                </button>
              </div>
              <div className="muted" style={{ fontSize: 13, marginTop: 6 }}>
                This key is meant to be used in frontend apps. Privacy comes from RLS + login, not from hiding the key.
              </div>

              {testMsg && (
                <div className="pill muted" style={{ marginTop: 12, fontSize: 13 }}>
                  {testMsg}
                </div>
              )}

              <div className="row" style={{ justifyContent: "flex-end", marginTop: 12 }}>
                <button className="btn ghost" onClick={clearDraft}>Clear</button>

                <button
                  className="btn ghost"
                  onClick={testConnection}
                  disabled={!draftUrl.trim() || !draftKey.trim() || testing}
                >
                  {testing ? "Testing…" : "Test connection"}
                </button>

                <button
                  className="btn"
                  onClick={saveSetup}
                  disabled={!draftUrl.trim() || !draftKey.trim()}
                >
                  Save
                </button>
              </div>

              <div className="muted" style={{ marginTop: 12, fontSize: 13 }}>
                Saved only in this browser (localStorage). Use “Start over” if you want to switch projects or clear it.
              </div>
            </div>
          </div>
        );
      }

      if (!supabase) {
        return (
          <div className="wrap">
            <Header theme={theme} setTheme={setTheme} right={<button className="btn ghost" onClick={resetSetup}>Start over</button>} />
            <div className="card">
              <div style={{fontWeight:900,marginBottom:6}}>Supabase not initialized</div>
              <div className="muted">Your saved credentials may be invalid. Click Start over and enter them again.</div>
            </div>
          </div>
        );
      }

      if (authLoading) {
        return (
          <div className="wrap">
            <Header theme={theme} setTheme={setTheme} right={<button className="btn ghost" onClick={resetSetup}>Change Supabase</button>} />
            <div className="empty">Checking login…</div>
          </div>
        );
      }

      if (!session) {
        return (
          <div className="wrap">
            <Header
              theme={theme}
              setTheme={setTheme}
              right={<div className="row">
                <button className="btn ghost" onClick={resetSetup}>Change Supabase</button>
              </div>}
            />
            <div className="card">
              <div style={{fontWeight:900,marginBottom:6}}>Sign in to your private tracker</div>
              <div className="muted" style={{marginBottom:12}}>
                Your data is private to your GitHub account (enforced by Supabase RLS).
              </div>
              <button className="btn" onClick={signInWithGitHub}>Sign in with GitHub</button>
            </div>
          </div>
        );
      }

      // ---- Main app (logged in)
      return (
        <div className="wrap">
          <Header
            theme={theme}
            setTheme={setTheme}
            right={
              <div className="row">
                <button className="btn ghost" onClick={resetSetup}>Change Supabase</button>
                <button className="btn ghost" onClick={signOut}>Sign out</button>
              </div>
            }
          />

          <div className="card">
            <div className="row">
              <input
                className="grow"
                placeholder="Search"
                value={q}
                onChange={(e)=>setQ(e.target.value)}
                onKeyDown={(e)=>e.key==="Enter" && doSearch()}
              />
              <button className="btn" onClick={doSearch} disabled={searching}>
                {searching ? "Searching…" : "Search"}
              </button>
            </div>

            {results.length > 0 && (
              <div className="sr">
                {results.map(r => (
                  <div key={r.show.id} className="srItem" onClick={()=>pickShow(r)}>
                    <img
                      src={r.show.image?.medium || r.show.image?.original || "https://via.placeholder.com/200x280?text=No+Image"}
                      alt={r.show.name}
                    />
                    <div style={{fontWeight:800}}>{r.show.name}</div>
                    <div className="muted" style={{fontSize:13}}>{r.show.premiered?.slice(0,4) || ""}</div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="tabs">
            {TABS.map(t => (
              <button
                key={t.key}
                className={`btn tab ${activeTab===t.key ? "active" : ""}`}
                onClick={()=>setActiveTab(t.key)}
              >
                {t.label} ({counts[t.key]})
              </button>
            ))}
          </div>

          <div className="row">
            <input className="grow" placeholder="Filter shows…" value={filter} onChange={(e)=>setFilter(e.target.value)} />
            <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)}>
              <option value="name">Sort: Name</option>
              <option value="progress">Sort: Progress</option>
              <option value="recent">Sort: Recent</option>
            </select>
          </div>

          {loading ? (
            <div className="empty">Loading your shows…</div>
          ) : visible.length === 0 ? (
            <div className="empty">
              <div style={{color:"var(--yellow)",fontWeight:900,fontSize:"1.1rem"}}>No shows here yet</div>
              <div className="muted">Search above and add a show to get started.</div>
            </div>
          ) : (
            <div className="grid">
              {visible.map(s => (
                <ShowCard key={s.id} show={s} onUpdate={updateShow} onDelete={removeShow} />
              ))}
            </div>
          )}

          {draft && (
            <AddModal show={draft} onClose={()=>setDraft(null)} onChange={setDraft} onSave={saveDraft} />
          )}
        </div>
      );
    }

    function Header({ theme, setTheme, right }) {
      return (
        <header>
          <h1>TV Show Tracker</h1>
          <div className="row">
            <button className="btn ghost" onClick={() => setTheme(theme === "dark" ? "light" : "dark")}>
              {theme === "dark" ? "Light" : "dark"}
            </button>
            {right}
          </div>
        </header>
      );
    }

    function ShowCard({ show, onUpdate, onDelete }) {
      const [eps, setEps] = useState(null);
      const [season, setSeason] = useState(show.current_season);
      const [ep, setEp] = useState(show.current_episode);

      const parseAirDate = (s) => (s ? new Date(`${s}T00:00:00`) : null);

      const today = useMemo(() => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d;
      }, []);

      useEffect(() => {
        let cancelled = false;
        (async () => {
          try {
            const list = await tvmazeEpisodes(show.tvmaze_id);
            if (!cancelled) setEps(Array.isArray(list) ? list : []);
          } catch {
            if (!cancelled) setEps([]);
          }
        })();
        return () => { cancelled = true; };
      }, [show.tvmaze_id]);

      const computed = useMemo(() => {
        if (!eps) return null;

        const withDate = eps.filter(e => e.airdate);
        const aired = withDate.filter(e => parseAirDate(e.airdate) <= today);

        const watchedAll = eps.filter(e =>
          (e.season < show.current_season) ||
          (e.season === show.current_season && e.number <= show.current_episode)
        );

        const watchedAired = aired.filter(e =>
          (e.season < show.current_season) ||
          (e.season === show.current_season && e.number <= show.current_episode)
        );

        const unaired = withDate
          .filter(e => parseAirDate(e.airdate) > today)
          .sort((a,b) => parseAirDate(a.airdate) - parseAirDate(b.airdate));

        const lastAired = aired
          .slice()
          .sort((a,b) => parseAirDate(a.airdate) - parseAirDate(b.airdate))
          .slice(-1)[0] || null;

        const dateEpisode = unaired[0] || lastAired || null;

        const seasonsCount = eps.reduce((m, e) => Math.max(m, e.season || 0), 0) || 0;

        return {
          seasonsCount,
          totalEpisodes: eps.length,
          totalAired: aired.length,
          watchedTotalCount: watchedAll.length,
          watchedAiredCount: watchedAired.length,
          remainingAiredCount: Math.max(0, aired.length - watchedAired.length),
          firstUnaired: unaired[0] || null,
          dateEpisode,
        };
      }, [eps, show.current_season, show.current_episode, today]);

      const progress = computed ? pct(computed.watchedTotalCount, computed.totalEpisodes) : 0;

      async function applyProgress() {
        const s = Math.max(1, season || 1);
        const e = Math.max(0, ep || 0);

        let watchedTotalCount = 0;
        let total = show.total_episodes || 0;

        if (eps && Array.isArray(eps)) {
          total = eps.length;
          watchedTotalCount = eps.filter(x =>
            (x.season < s) || (x.season === s && x.number <= e)
          ).length;
        }

        let status = show.status;
        if (total && watchedTotalCount >= total) status = "completed";
        else if (watchedTotalCount > 0) status = "in-progress";
        else status = "not-started";

        await onUpdate(show.id, { current_season: s, current_episode: e, status });
      }

      const seasonsLabel =
        computed?.seasonsCount
          ? `${computed.seasonsCount} ${computed.seasonsCount === 1 ? "Season" : "Seasons"}`
          : "—";

      const episodesTotal = computed?.totalEpisodes ?? show.total_episodes ?? 0;
      const episodesLabel = `${episodesTotal} ${episodesTotal === 1 ? "episode" : "episodes"}`;

      return (
        <div className="card">
          <div className="showH">
            <img className="poster" src={show.image_url || "https://via.placeholder.com/100x140?text=No+Image"} alt={show.name} />
            <div className="grow">
              <h3 className="title">{show.name}</h3>

              <div className="muted" style={{fontSize:13}}>
                <div>{seasonsLabel} • {episodesLabel}</div>
              </div>

              {show.source ? (
                <a className="muted" style={{fontSize:13}} href={show.source} target="_blank" rel="noopener noreferrer">Watch source</a>
              ) : null}
            </div>
          </div>

          <div className="muted" style={{marginTop:10,fontSize:13}}>
            S{show.current_season} E{show.current_episode} • {show.total_episodes || 0} eps
          </div>

          <div className="bar">
            <div className="fill" style={{ width: `${progress}%` }}>{`${progress}%`}</div>
          </div>

          <div className="muted" style={{fontSize:13}}>
            {computed
              ? (computed.remainingAiredCount
                  ? `${computed.remainingAiredCount} episodes available to watch`
                  : "All caught up (on aired episodes)!")
              : "…"}
          </div>

          {computed?.dateEpisode?.airdate ? (
            <div className="pill muted" style={{fontSize:13}}>
              <b style={{color:"var(--yellow)"}}>
                {computed.firstUnaired ? "First unaired airs:" : "Last episode aired:"}
              </b>{" "}
              {computed.dateEpisode.airdate}
            </div>
          ) : null}

          <div className="row controls" style={{marginTop:12}}>
            <span className="muted" style={{fontSize:13}}>S</span>
            <input type="number" min="1" value={season} onChange={(e)=>setSeason(parseInt(e.target.value)||1)} />
            <span className="muted" style={{fontSize:13}}>E</span>
            <input type="number" min="0" value={ep} onChange={(e)=>setEp(parseInt(e.target.value)||0)} />
            <button className="btn" style={{padding:"8px 12px"}} onClick={applyProgress}>Update</button>
            <button className="btn danger" style={{padding:"8px 12px"}} onClick={()=>onDelete(show.id)}>Delete</button>
          </div>
        </div>
      );
    }

    function AddModal({ show, onClose, onChange, onSave }) {
      return (
        <div className="modal" onClick={onClose}>
          <div className="card" onClick={(e)=>e.stopPropagation()}>
            <div className="row" style={{justifyContent:"space-between",alignItems:"flex-start"}}>
              <div>
                <div style={{color:"var(--yellow)",fontWeight:900,fontSize:"1.15rem"}}>Add: {show.name}</div>
                <div className="muted" style={{fontSize:13}}>Total Episodes: {show.total_episodes || 0}</div>
              </div>
              <button className="btn ghost" style={{padding:"8px 12px"}} onClick={onClose}>Close</button>
            </div>

            <label>Starting Season</label>
            <input type="number" min="1" value={show.current_season}
              onChange={(e)=>onChange({ ...show, current_season: parseInt(e.target.value) || 1 })} />

            <label>Starting Episode</label>
            <input type="number" min="0" value={show.current_episode}
              onChange={(e)=>onChange({ ...show, current_episode: parseInt(e.target.value) || 0 })} />

            <label>Watch Source (URL or platform)</label>
            <input type="text" placeholder="Netflix or https://…" value={show.source || ""}
              onChange={(e)=>onChange({ ...show, source: e.target.value })} />

            <label>Status</label>
            <select value={show.status} onChange={(e)=>onChange({ ...show, status: e.target.value })}>
              <option value="not-started">Not Started</option>
              <option value="in-progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>

            <div className="row" style={{justifyContent:"flex-end",marginTop:12}}>
              <button className="btn ghost" onClick={onClose}>Cancel</button>
              <button className="btn" onClick={onSave}>Add Show</button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
